<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=10">
    <title>响应方案管理</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="dist/css/ionicons.min.css">
    <link rel="stylesheet" href="dist/css/AdminLTE.css">
    <link rel="stylesheet" href="dist/css/skins/_all-skins.css">
    <link rel="stylesheet" href="vince/css/vince.css">
    <link rel="stylesheet" href="vince/biao/css/font-awesome.min.css">
    <!--[if lt IE 9]>
    <script src="dist/js/html5shiv.min.js"></script>
    <script src="dist/js/respond.min.js"></script>
    <![endif]-->
</head>
<body class="hold-transition skin-blue sidebar-mini">


<div class="fuceng" id="tanchuang">
    <div class="fuqu">
        <div class="fuquzone">
            <div class="fuqulogo">

            </div>
            <p class="fuqutitle">
                方案管理
                <span class="fuclose" id="close-btn">×</span>
            </p>
            <div class="fuqubiao">
                <p><span>方案名称</span><input type="text" id="scheme-name"></p>
                <p><span class="tiaoshijian">响应开始时间：</span>
                    <input type="text" class="shi" id="xuanshi2" readonly value="2020-03-29">
                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i></p>
                <p><span class="tiaoshijian">调节结束时间: </span>
                    <input type="text" class="shi" id="xuanshi3" readonly value="2020-03-30">
                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i></p>
                <p><span>调节目标:</span><input type="text" id="adjusting-targets"></p>
                <p><span>奖励金额:</span><input type="text" id="bonus"></p>

            </div>

            <div class="fuqusave">
                <input type="button" value="保存" id="safe-btn">
            </div>
        </div>
    </div>
</div>

<div class="fuceng" id="tanchuang1">
    <div class="fuqu">
        <div class="fuquzone">
            <div class="fuqulogo">

            </div>
            <p class="fuqutitle">
                添加策略
                <span class="fuclose">×</span>
            </p>

            <div class="fuquqie">
                <p>
                    <span class="fuquqieone fuquxuanbai">控制策略列表</span>
                    <!--<span class="fuquqietwo">推荐策略列表</span>-->
                </p>
            </div>
            <div class="fuquqienei">
                <div class="fuquqieju fuquqiezuo">
                    <p>可用的策略列表</p>
                    <div class="fuqutable" id="enable-strategy-table" style="width: 230%">
                        <!--<li><span>策略名称</span><span>目标负荷</span><span>操作</span></li>-->
                        <!--<li><span>策略1</span><span>1000KW</span><span><img src="vince/images/icon_27.png" alt=""></span>-->
                        <!--</li>-->
                        <!--<li><span>策略2</span><span>1000KW</span><span><img src="vince/images/icon_27.png" alt=""></span>-->
                        <!--</li>-->
                    </div>
                </div>
                <!--<div class="fuquqieju">-->
                <!--<p>控制策略池：</p>-->
                <!--<div class="fuqutable">-->
                <!--<li><span>策略名称</span><span>目标负荷</span><span>操作</span></li>-->
                <!--<li><span>策略1</span><span>1000KW</span><span><img src="vince/images/icon_27.png" alt=""></span>-->
                <!--</li>-->
                <!--<li><span>策略2</span><span>1000KW</span><span><img src="vince/images/icon_27.png" alt=""></span>-->
                <!--</li>-->
                <!--</div>-->
                <!--</div>-->
                <div class="clear"></div>
            </div>
            <div class="fuqusave">
                <!--<input type="button" value="保存" id="safe-btn1">-->
            </div>
        </div>
    </div>
</div>


<div class="wrapper">
    <header class="main-header">
        <a href="#" class="logo">
      <span class="logo-mini">
	  <img src="vince/images/v01.png">
	  </span>
            <span class="logo-lg"><img src="vince/images/v01.png">项目</span>
        </a>
        <nav class="navbar navbar-static-top">
            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button"></a>
            <span class="all_title">华北理工大学能源优化调配及集群负荷控制系统</span>
            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <li class="dropdown user user-menu">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <img src="dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
                            <span class="hidden-xs" id="right-admin-name">管理员</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="user-header">
                                <img src="dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                                <p id="right-second-admin">
                                    姓名：管理员
                                    <!--<small>部门：信息部</small>-->
                                </p>
                            </li>
                            <li class="user-footer">
                                <div class="pull-right">
                                    <a href="login.html" class="btn btn-default btn-flat">退出系统</a>
                                </div>
                            </li>
                        </ul>
                    </li>

                </ul>
            </div>
        </nav>
    </header>
    <aside class="main-sidebar">
        <section class="sidebar">
            <div class="user-panel">
                <div class="pull-left image">
                    <img src="dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                </div>
                <div class="pull-left info">
                    <p id="adminTxt">当前用户：管理员</p>
                    <p class="menu_time">
                        时间：<span id="nowTime">2016-9-13 16:12:14</span></p>
                </div>
            </div>

            <ul class="sidebar-menu">
                <li class="header">菜单 MENU</li>
                <li>
                    <a href="index.html">
                        <i class="fa fa-home" style="font-size: 22px"></i> <span>首页</span>
                    </a>
                </li>
                <li>
                    <a href="ssjc.html">
                        <i class="fa fa-eye"></i> <span>实时监测</span>
                    </a>
                </li>
                <li>
                    <a href="yxjc.html">
                        <i class="fa fa-print"></i> <span>运行监测</span>
                    </a>
                </li>
                <li class="treeview active">
                    <a href="#">
                        <i class="fa fa-sliders"></i>
                        <span>负荷响应</span>
                        <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="xyxgpj.html"><i class="fa fa-bookmark"></i> 响应效果评价</a></li>
                        <li><a href="fhxyfx.html"><i class="fa fa-bookmark"></i> 负荷响应分析</a></li>

                        <li class="active"><a href="xyfagl.html"><i class="fa fa-bookmark"></i> 响应方案管理</a></li>
                    </ul>
                </li>

                <li>
                    <a href="yjgl.html">
                        <i class="fa fa-bell"></i> <span>预警管理</span>
                    </a>
                </li>
                <li class="treeview">
                    <a href="#">
                        <i class="fa fa-gears"></i>
                        <span>设备管理</span>
                        <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="sbrk.html"><i class="fa fa-bookmark"></i> 设备入库</a></li>
                        <li><a href="sbaz.html"><i class="fa fa-bookmark"></i> 设备安装</a></li>
                        <li><a href="sbjx.html"><i class="fa fa-bookmark"></i> 设备检修</a></li>
                        <li><a href="sbbf.html"><i class="fa fa-bookmark"></i> 设备报废</a></li>
                        <li><a href="sbcx.html"><i class="fa fa-bookmark"></i> 设备查询</a></li>
                    </ul>
                </li>
                <li>
                    <a href="kzcl.html">
                        <i class="fa fa-magnet"></i> <span>控制策略</span>
                    </a>
                </li>
                <li>
                    <a href="xtjc.html">
                        <i class="fa fa-map"></i> <span>系统集成</span>
                    </a>
                </li>
            </ul>
        </section>
    </aside>
    <div class="content-wrapper">
        <section class="content-header">
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
                <li class="active">响应方案管理</li>
            </ol>
        </section>
        <div class="content qqq">
            <div class="ssjc">
                <div class="row">

                    <div class="col-md-12 ssjc_right">

                        <div class="xyfagl_right_up">
                            <div class="nei">
                                <div class="ssjc_ru_title xyfa_title">
                  <span>
                    方案名称：
                    <input type="text" class="shi" id="scheme-name-input">
                  </span>
                                    <span class="tiaoshijian">
                    响应时间：
                    <input type="text" class="shi" id="xuanshi1" readonly value="2020-03-31">
                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                                    <span class="float_right">
                    <input type="submit" value="刷新" class="youcecha" id="refresh-btn">
                  </span>
                                    <span class="float_right">
                    <input type="submit" value="导出" class="youcecha" id="export-btn">
                  </span>

                                    <span class="float_right">
                    <input type="submit" value="查询" class="youcecha" id="query-select-btn">
                  </span>
                                    <span class="float_right"><input type="submit"
                                                                     value="新建方案"
                                                                     class="youcecha "
                                                                     id="new-scheme-btn"></span>
                                    <div class="clear"></div>
                                </div>

                            </div>
                            <div class="xyfagl_right_bottom">
                                <div class="nei ">
                                    <p>数据列表</p>
                                    <div class="ssjc_rub_table">
                                        <table class="tj_table" border="0">
                                            <thead>
                                            <tr>
                                                <td>方案序号</td>
                                                <td>方案名称</td>
                                                <td>策略总负荷</td>
                                                <td>策略组成</td>
                                                <td>目标负荷</td>
                                                <td>调节目标</td>
                                                <td>操作</td>
                                                <td>起始时间</td>
                                                <td>奖励金额</td>
                                            </tr>
                                            </thead>
                                            <tbody id="scheme-container">

                                            </tbody>

                                        </table>
                                        <div class="t_fanye">
                                            <span class="upten" id="start_page_btn"></span>
                                            <span class="up" id="prev_btn"></span>
                                            <span class="split"></span>
                                            <span class="page_info_one" id="current_page">第 1 / 1 页</span>
                                            <span class="split"></span>
                                            <span class="dowm" id="next_btn"></span>
                                            <span class="downten" id="last_page_btn"></span>
                                            <span class="page_info_two" id="total_page">共 1 页</span>
                                            <span class="page_info_three" id="single_page_count">共 0 条记录</span>
                                            <div class="clear"></div>
                                        </div>

                                    </div>
                                    <div class="cheng_ershi"></div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="main-footer">
        <div class="pull-right hidden-xs">
            <b></b>
        </div>
        <strong>Copyright &copy; 2014-2016</strong>
    </footer>
    <div class="control-sidebar-bg"></div>
</div>


<script src="plugins/jQuery/jquery-2.2.3.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="dist/js/app.min.js"></script>
<!--<script src="dist/js/demo.js"></script>-->
<script src="vince/js/nicescroll.js"></script>
<script src="vince/js/demo.js"></script>
<script src="vince/datapick/js/moment.js"></script>
<script src="vince/datapick/js/daterangepicker.js"></script>
<script type="text/javascript" src="vince/js/globalInfo.js"></script>
<script type="text/javascript" src="plugins/layer-v3.1.1/layer/layer.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#xuanshi1').daterangepicker({singleDatePicker: true}, function (start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
        $('#xuanshi2').daterangepicker({singleDatePicker: true}, function (start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
        $('#xuanshi3').daterangepicker({singleDatePicker: true}, function (start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
    });
</script>


<div id="sss" style="display:none;height:200px;width:200px;"></div>
<script src="vince/js/echarts.min.js"></script>
<script type="text/javascript">
    // var myChart1 = echarts.init(document.getElementById('sss'));
    // option1 = {
    //     series: [{data: [247, 179]}]
    // };
    // myChart1.setOption(option1);

    var scheme_container = $('#scheme-container');
    var start_page_btn = $('#start_page_btn');
    var prev_btn = $('#prev_btn');
    var next_btn = $('#next_btn');
    var last_page_btn = $('#last_page_btn');

    var currPage = 1;
    var lastPage = 1;

    var scheme_name = $('#scheme-name');
    var start_time = $('#xuanshi2');
    var end_time = $('#xuanshi3');
    var adjusting_targets = $('#adjusting-targets');
    var bonus = $('#bonus');

    var safe_btn = $('#safe-btn');
    var query_select_btn = $('#query-select-btn');
    var scheme_name_input = $('#scheme-name-input');
    var response_date = $('#xuanshi1');
    var new_scheme_btn = $('#new-scheme-btn');
    var export_btn = $('#export-btn');
    var refresh_btn = $('#refresh-btn');

    var handle;

    var enable_strategy_table = $('#enable-strategy-table');


    $(function () {
        showResponseSchemeList(null, null);

        next_btn.click(function () {
            currPage = currPage + 1;
            if (currPage > lastPage)
                currPage = lastPage;
            showResponseSchemeList(null, null);
        });

        prev_btn.click(function () {
            currPage = currPage - 1;
            if (currPage < 1)
                currPage = 1;
            showResponseSchemeList(null, null);
        });

        last_page_btn.click(function () {
            currPage = lastPage;
            showResponseSchemeList(null, null);
        });

        start_page_btn.click(function () {
            currPage = 1;
            showResponseSchemeList(null, null);
        });

        safe_btn.click(function () {
            addResponseScheme();
        });

        query_select_btn.click(function () {
            showResponseSchemeList(scheme_name_input.val(), response_date.val());
        });

        new_scheme_btn.click(function () {
            $('#tanchuang').show();
        });

        export_btn.click(function () {

        });

        refresh_btn.click(function () {
            showResponseSchemeList(null, null);
        });
    });

    /**
     * 添加响应方案
     */
    function addResponseScheme() {
        if (checkDate(start_time.val(), end_time.val())) {
            $.getJSON(
                'ajax_add_response_scheme',
                {
                    scheme_name: scheme_name.val(),
                    adjust_target: adjusting_targets.val(),
                    start_time: start_time.val(),
                    end_time: end_time.val(),
                    bonus: bonus.val()
                },
                function (data) {
                    if (data.code == 1) {
                        layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                            $('#tanchuang').hide();
                            safe_btn.unbind('click');
                            showResponseSchemeList(null, null);
                        })
                    } else {
                        layer.msg(data.msg, {icon: 5, time: 1000});
                    }
                }
            )
        }
    }

    /**
     * 显示所有响应方案的列表
     */
    function showResponseSchemeList(scheme_name_str, response_date_str) {
        scheme_container.empty();

        $.getJSON(
            'ajax_response_scheme_list',
            {
                scheme_name: scheme_name_str,
                start_time: response_date_str,
                current_page: currPage
            },
            function (data) {
                if (data.code == 11) {
                    $.each(data.response_scheme_list, function (i, v) {
                        $('#current_page').text('第 ' + data.page.current_page + '/' + data.page.page_count + ' 页');
                        $('#total_page').text('共 ' + data.page.page_count + ' 页');
                        $('#single_page_count').text('共 ' + data.page.record_count + ' 条记录');
                        lastPage = data.page.page_count;

                        var tr = $('<tr></tr>');
                        var td1 = $('<td></td>').text(v.rsid);
                        var td2 = $('<td></td>').text(v.scheme_name);
                        var td3 = $('<td></td>');
                        var td4 = $('<td></td>');
                        var td5 = $('<td></td>');
                        var td6 = $('<td></td>').text(v.adjust_target + 'W');
                        var td7 = $('<td></td>').text('');
                        var td8 = $('<td></td>').text(v.start_time);
                        var td9 = $('<td></td>').text(v.bonus);

                        var handle = $('<a style="cursor: pointer" onclick="deleteSchemeItem(' + v.rsid + ')">删除</a><span> | </span><a style="cursor: pointer" onclick="openAddStrategyWindow(' + v.rsid + ')">添加策略</a>');

                        td7.append(handle);
                        tr.append(td1).append(td2).append(td3).append(td4).append(td5).append(td6).append(td7).append(td8).append(td9);
                        scheme_container.append(tr);


                        getAddedSchemeByRsid(v.rsid, td3, td4, td5);
                    })
                } else {
                    layer.msg(data.msg, {icon: 5, time: 1000});
                }
            }
        )
    }

    /**
     * 删除指定响应方案条目
     */
    function deleteSchemeItem(rsid) {
        $.getJSON(
            'ajax_delete_scheme_item',
            {
                rsid: rsid
            },
            function (data) {
                if (data.code == 21) {
                    layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                        showResponseSchemeList(null, null);
                    })
                } else {
                    layer.msg(data.msg, {icon: 5, time: 1000});
                }
            }
        )
    }

    /**
     * 添加策略
     */
    function openAddStrategyWindow(rsid) {
        $('#tanchuang1').show();

        showControlStrategyOnEable(rsid);
    }

    /**
     * 显示所有可用的控制策略信息
     */
    function showControlStrategyOnEable(rsid) {
        enable_strategy_table.empty();
        var li0 = $('<li><span>目标名称</span><span>目标负荷</span><span>操作</span></li>');
        enable_strategy_table.append(li0);
        $.getJSON(
            'ajax_control_strategy_list_on_enable',
            {
                is_enable: '可用'
            },
            function (data) {
                if (data.code == 11) {
                    $.each(data.control_strategy_list, function (i, v) {
                        var li = $('<li></li>');

                        var span2 = $('<span></span>').text(v.csid + '.' + v.strategy_name);
                        var span3 = $('<span></span>').text(v.target_load);
                        var span4 = $('<span></span>');

                        handle = $('<a style="cursor: pointer;color: #399ad7;text-decoration:underline" onclick="addControlStrategyIntoResponseScheme(' + rsid + ',' + v.csid + ')"></a>').text('添加');

                        span4.append(handle);
                        li.append(span2).append(span3).append(span4);
                        enable_strategy_table.append(li);
                    })
                }
            }
        )
    }

    /**
     * 向响应方案中添加控制策略
     */
    function addControlStrategyIntoResponseScheme(rsid, csid) {
        $.getJSON(
            'ajax_add_control_strategy_into_response_scheme',
            {
                rsid: rsid,
                csid: csid
            },
            function (data) {
                if (data.code == 1) {
                    layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                        showResponseSchemeList(null, null)
                    })
                } else {
                    layer.msg(data.msg, {icon: 5, time: 1000});
                }
            }
        )
    }

    /**
     * 根据rsid获取所有的对应添加过的策略条目信息
     */
    function getAddedSchemeByRsid(rsid, obj3, obj4, obj5) {
        $.ajax({
            url: 'ajax_get_added_scheme_by_rsid',
            data: {
                rsid: rsid
            },
            dataType: "JSON",
            type: "GET",
            async: false
        }).done(function (data) {
            if (data.code == 11) {
                var s = '';
                var p = '';
                var tp = 0;
                $.each(data.rs_and_cs, function (i, v) {
                    if (rsid == v.rsid) {
                        tp = tp + v.target_load;
                        obj3.text(tp + 'W');

                        s = s + (i + 1) + '.' + v.strategy_name + '<br>';
                        obj4.html(s);

                        p = p + v.target_load + 'W' + '<br>';
                        obj5.html(p);
                    }
                });
            }
        });
    }

    /**
     * 选择日期结束时间不能早于开始时间
     * @param date1
     * @param date2
     * @returns {boolean}
     */
    function checkDate(date1, date2) {
        var y1 = date1.split('-')[0];
        var m1 = date1.split('-')[1];
        var d1 = date1.split('-')[2];

        var y2 = date2.split('-')[0];
        var m2 = date2.split('-')[1];
        var d2 = date2.split('-')[2];

        if (y1 <= y2) {
            if (y1 == y2) {
                if (m1 <= m2) {
                    if (m1 == m2) {
                        if (d1 < d2) {
                            return true
                        } else {
                            return false
                        }
                    }
                    return true
                } else {
                    return false
                }
            }
            return true
        } else {
            return false
        }
    }
</script>
</body>
</html>